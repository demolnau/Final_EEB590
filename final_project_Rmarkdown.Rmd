---
title: "Final Project - EEB590C"
author: "Devin Molnau and Elizabeth McMurchie"
date: "April 29, 2021"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Homework 3
This assignment is due prior to the last day class. You are to self-select and work in groups: 2-3 in a group. For the assignment below submit one R-script. Annotations via comments are highly encouraged. The script should run!

### Assignment:

1: Obtain a dataset. This may be one of your own, a dataset from DRYAD, or some other source. Identify hypotheses for this dataset and analyze patterns in the data. You may use any methods learned during the semester, but at least one analysis must come from material learned in weeks 11-13.

USE COMMENTS IN THE R CODE to describe what the patterns you find represent.
```{r, results='hide',message=FALSE,warning=FALSE}
setwd("D:/Documents/BoxSync/Classes_Spring2021/Advanced_Biostatistics_EEB590C/Homework/Final_EEB590")
#load appropriate libraries
library(knitr)
library(RRPP)
library(geomorph)
library(tidyverse)
library(readxl)
library(ade4)
library(vegan)
library(mice)
library(ggplot2)
```

## Intro

 Epidermal micromorphology in Neotropical bamboo foliage leaves has proven to be a useful tool for differentiating between different species. Certain unusual features have been noted in the epidermal micromorphology of one species of savanna bamboo, Guadua paniculata, including papillae on both leaf surfaces and saddle-shaped silica cells. However, it remains unknown whether the few other species of Guadua primarily found in forests, including G. virgata, have similar micromorphology. Additionally, there are several general trends in Guadua macromorphology, including the G. angustifolia type, which are tall, primarily forest-adapted species, the G. glomerata type, which are scandent species primarily found along rivers, the G. sarcocarpa type, which are similar to G. angustifolia but notable for their tree-killing ability, and species of both savanna and forest bamboos that closely resemble G. paniculata. Here, we analyzed whether micromorphological features such as shape of silica bodies and presence, placement, and shape of stomata and papillae on epidermal cells of foliage leaves were associated with different patterns in macromorphology, habitat type, and country of origin of specimens belonging to a selection of species of Guadua.

## Preprocessing

#### Read in data

```{r}
#READ IN DATA AS DATAFRAME
mydata<-read_excel(path="data/TransformGuaduaSet.xlsx", col_names = TRUE, na="x")

```

#### Remove Column V and Y
Remove column V and Y, because there is missing data and we cannot impute the data because it just doesn't make sense to attempt to predict these columns.

 V. Adaxial: Frequency of stomates if present on the adaxial surface of foliage leaf blades:  0 = common; 1 = infrequent.
Y. Adaxial: Papillae on long cells of the intercostal zone adjacent to the stomates:  0 = not overarching the stomates; 1 = overarching the stomates.
```{r}
to_drop<-c("Adaxial: Papillae on long cells of the intercostal zone adjacent to the stomates:  0 = not overarching the stomates; 1 = overarching the stomates.","Adaxial: Frequency of stomates if present on the adaxial surface of foliage leaf blades:  0 = common; 1 = infrequent.")

df=data.frame(mydata[,!( names(mydata) %in% to_drop)],stringsAsFactors = TRUE)
```

#### Set columns to factors
```{r}
df<-data.frame(lapply(df,as.factor))
```

#### Imputation of missing data

In the last three columns, in some species the papillae of the cells adjacent to the stomata obscured theshape of the subsidiary cells. Therefore, the shapes of these subsidiary cells resulted in missing data that we imputed using the MICE package's logistic regression method. 

```{r}
init = mice(df,maxit=0)
meth = init$method
predM=init$predictorMatrix
meth[c(colnames(df[,7:length(df)]))]<-"logreg"
set.seed(183)
imputed<-mice(df,method = meth, predictorMatrix = predM, m=5,printFlag = FALSE)
imputed<-complete(imputed)
```


```{r}
check_is_boolean<-sapply(imputed,function(x) sum(is.na(x))) #double check to make sure there are no more NA
```

## Analysis

### PCOA

```{r}
#TODO

Y<-imputed[,7:ncol(imputed)]
Y<-data.frame(lapply(Y,function(x) as.numeric(levels(x))[x]))
Y.dist<-dist.binary(Y, method=2, diag = FALSE, upper = FALSE) #Distance matrix for binary is simple matching coefficient
PCoA<-cmdscale(Y.dist)   #from vegan
```

#### PCoA grouped by Country

```{r}
nice_df <- PCoA %>% 
  data.frame
nice_df$country <- df$Country
nice_df %>% 
  ggplot(aes(X1, X2)) +
  geom_point(aes(color = country), size = 2) +
  scale_color_viridis_d() + 
  theme_minimal() +
  theme(
    panel.border = element_rect(size = 2, color = "black", fill = NA)
  ) + 
  labs(
    color = "Country", 
    x = "Axis 1",
    y = "Axis 2"
  )
  
```

#### PCoA grouped by Group1

```{r}
nice_df$Group_1<- df$Group_1
nice_df %>% 
  mutate(
    Group_1 = str_to_title(str_replace_all(Group_1, "_", " "))
  ) %>%
  ggplot(aes(X1, X2)) +
  geom_point(aes(color = Group_1), size = 2) +
  scale_color_viridis_d() + 
  theme_minimal() +
  theme(
    panel.border = element_rect(size = 2, color = "black", fill = NA)
  ) + 
  labs(
    color = "Group 1", 
    x = "Axis 1",
    y = "Axis 2"
  )
 
```

#### PCoA grouped by Group 2

```{r}
nice_df$Group_2<- df$Group_2
nice_df %>% 
  mutate(
    Group_2 = str_to_title(str_replace_all(Group_2, "_", " "))
  ) %>%
  ggplot(aes(X1, X2)) +
  geom_point(aes(color = Group_2), size = 2) +
  scale_color_viridis_d() + 
  theme_minimal() +
  theme(
    panel.border = element_rect(size = 2, color = "black", fill = NA)
  ) + 
  labs(
    color = "Group 2", 
    x = "Axis 1",
    y = "Axis 2"
  )
  
```

#### PCoA grouped by Habitat

```{r}
nice_df$Habitat<- df$Habitat
nice_df %>% 
  mutate(
    Habitat = str_to_title(str_replace_all(Habitat, "_", " "))
  ) %>%
  ggplot(aes(X1, X2)) +
  geom_point(aes(color = Habitat), size = 2) +
  scale_color_viridis_d() + 
  theme_minimal() +
  theme(
    panel.border = element_rect(size = 2, color = "black", fill = NA)
  ) + 
  labs(
    color = "Habitat", 
    x = "Axis 1",
    y = "Axis 2"
  )
 
```



#### FACTORIAL MANOVA 

```{r}
#Factorial MANOVA via RRPP

Y<-imputed[,7:ncol(imputed)]
Y<-data.frame(lapply(Y,function(x) as.numeric(levels(x))[x]))

mydat<-rrpp.data.frame("Y"=imputed[,7:ncol(imputed)],
                       "Group_2"= as.factor(imputed$Group_2),
                       "Habitat"=as.factor(imputed$Habitat), 
                       "Country" = as.factor(imputed$Country))

model2.rrpp <- lm.rrpp(Y.dist~ mydat$Group_2 * mydat$Habitat * mydat$Country, print.progress = FALSE)
anova(model2.rrpp)
```


### MODEL COMPARISON USING LIKELIHOOD RATIO TEST (LTR)
#### Setup
```{r}
Y.dist.matrix<-as.matrix(Y.dist)
#model2.rrpp <- lm.rrpp(Y.dist~ mydat$Group_2 * mydat$Habitat * mydat$Country, print.progress = FALSE)
Y.group2<-lm(Y.dist.matrix ~ mydat$Group_2, model=T,x=T)
Y.habitat<-lm(Y.dist.matrix ~ mydat$Habitat, model=T,x=T)
Y.country<-lm(Y.dist.matrix ~ mydat$Country, model=T,x=T)
Y.group2.habitat<-lm(Y.dist.matrix ~ mydat$Group_2 + mydat$Habitat, model=T,x=T)
Y.group2.by.country<-lm(Y.dist.matrix ~ mydat$Group_2 + mydat$Country, model=T,x=T)
Y.habitat.country<-lm(Y.dist.matrix ~ mydat$Habitat + mydat$Country, model=T,x=T)
Y.habitat.by.country<-lm(Y.dist.matrix ~mydat$Group_2 * mydat$Habitat, model=T,x=T)
Y.mancova<-lm(Y.dist.matrix ~mydat$Group_2 + mydat$Habitat*mydat$Country, model=T,x=T)
Y.mancova_2<-lm(Y.dist.matrix ~mydat$Habitat + mydat$Group_2*mydat$Country, model=T,x=T)
Y.full<-lm(Y.dist.matrix ~ mydat$Group_2 * mydat$Habitat * mydat$Country, model=T,x=T)
```

```{r}
#anova(Y.full)
# anova(Y.group2.habitat,Y.group2)
# anova(Y.group2.habitat,Y.habitat)
# anova(Y.mancova,Y.group2.habitat)

#Error in anova.mlm(Y.full) : residuals have rank 31 < 55
```

#### Would AIC fix the problem we are having? Is this a dimensionality problem?
